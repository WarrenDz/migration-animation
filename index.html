<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>Migration Animation</title>

    <!-- Load Calcite components from CDN -->
    <script type="module" src="https://js.arcgis.com/calcite-components/3.0.3/calcite.esm.js"></script>

    <!-- Load the ArcGIS Maps SDK for JavaScript from CDN -->
    <link rel="stylesheet" href="https://js.arcgis.com/4.32/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.32/"></script>

    <!-- Load Map components from CDN-->
    <script
      type="module"
      src="https://js.arcgis.com/map-components/4.32/arcgis-map-components.esm.js"
    ></script>

    <style>
      html,
      body {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }

      arcgis-map {
        height: 100%;
        width: 100%;
      }

      #container {
        display: flex;
        flex-direction: column;
        width: 100%;
        height: 100%;
      }

      calcite-panel {
        width:300px;
      }
    </style>
  </head>

  <body>
    <div id="container">
      <arcgis-map item-id="7052c87d2d0742dbb9ed332122b9f2f6" zoom="3" center="-85.512764, 32.04355">
        <arcgis-zoom position="top-left"></arcgis-zoom>
        <arcgis-expand position="top-left" mode="floating">
        </arcgis-expand>
      </arcgis-map>
      <arcgis-time-slider mode="time-window" play-rate="150" loop="True"></arcgis-time-slider>
    </div>
    <script>
      require([
        "esri/Map","esri/layers/FeatureLayer"], (Map, FeatureLayer) => (async () => {
         // get the arcgis-map component element and wait for it to be ready
        const arcgisMap = document.querySelector("arcgis-map");


        // Set a basic symbol on a layer to visualize all features the same way
        const ospreyRenderer = {
          type: "simple",  // autocasts as new SimpleRenderer()
          symbol: {
            type: "simple-marker",  // autocasts as new SimpleMarkerSymbol()
            size: 6,
            color: "black",
            outline: {  // autocasts as new SimpleLineSymbol()
              width: 0.5,
              color: "white"
            }
          }
        };

        // // Define track info for the layer
        // const ospreyTrackInfo = new TrackInfo({
        //     enabled: "True",
        //     timeField: "timestamp"
        // })


// trackInfo.trackLines = {
//   renderer: {
//     type: "simple",
//     symbol: {
//       type: "simple-line",
//       color: "green",
//       width: 2
//     }
//   }
// };

// trackInfo.previousObservations = {
//   renderer: {
//     type: "simple",
//     symbol: {
//       type: "simple-marker",
//       style: "circle",
//       color: "blue",
//       size: 10
//     }
//   }
// };

        // Osprey telemetry
        const featureLayer = new FeatureLayer({
          url: "https://services.arcgis.com/nzS0F0zdNLvs7nc8/arcgis/rest/services/Migration_Routes/FeatureServer/2",
          renderer: ospreyRenderer,
          timeInfo: {
            startField: "timestamp", // name of the date field
            interval: {
              unit: "days", // set time interval to one day
              value: 1
            },
            trackIdField: "individual_local_identifier"
          }
        });

        if (!arcgisMap.ready) {
          arcgisMap.addEventListener("arcgisViewReadyChange", handleMapReady, {
            once: true
          });
        } else {
          handleMapReady();
        }

        async function handleMapReady() {
          // wait for the layer view to be ready
          arcgisMap.map.add(featureLayer);
          const layerView = await arcgisMap.whenLayerView(featureLayer);

          // Display earthquakes that occurred between 05/25 - 06/17, with a one-day interval
          const timeSlider = document.querySelector("arcgis-time-slider");
          timeSlider.fullTimeExtent = featureLayer.timeInfo.fullTimeExtent.expandTo("days");
          timeSlider.stops = {
            interval: {
              value: 1,
              unit: "days"
            }
          };

          // set time slider's full extent to 7/01/5016 - until end date of layer's fullTimeExtent
          const start = new Date(2016, 7, 1);
          timeSlider.fullTimeExtent = {
            start: start,
            end: featureLayer.timeInfo.fullTimeExtent.end
          };

          // Set the time slider initial time extent
          let end = new Date(start.getTime() + 24 * 60 * 60 * 1000);
          timeSlider.timeExtent = { start, end };

          // Start a TimeSlider animation if not already playing.
          if (timeSlider.state === "ready") {
            timeSlider.play();
          }

          // listen to time slider component's arcgisPropertyChange event. The event's payload contains
          // info about the time slider's current time extent change.
          // Update the telemetry layer and its layer view based on the time slider's current time extent.

          timeSlider.addEventListener("arcgisPropertyChange", async (event) => {
            try {
              // Only show points up until the end of timeSlider's current time extent.
              const date = new Date(timeSlider.timeExtent.end).toISOString().replace("T", " ").replace("Z", "");
              featureLayer.definitionExpression = `timestamp <= Timestamp '${date}'`;

              // Gray out points that happened before the time slider's current timeExtent.
              layerView.featureEffect = {
                filter: {
                  timeExtent: timeSlider.timeExtent,
                  geometry: arcgisMap.extent
                },
                excludedEffect: "grayscale(20%) opacity(50%)"
              };
              

            } catch (error) {
              console.error(error);
            }
          });
         }
      })());
    </script>
  </body>
</html>